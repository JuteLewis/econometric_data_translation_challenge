---
title: "How has COVID affected the health of the retail industry, as measured by employment?"
author: "Mikayla Davis, Glen Lewis"
date: "3/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo = FALSE, message = FALSE, warning = FALSE}
#library build

library(tidyverse)
library(jtools)
library(vtable)
library(haven)
library(lubridate)
library(estimatr)
library(car)

# following code establishes a function to convert variable class()

class_conversion <- function(df, x, y){
  'str_prefix' = x
  'new_class' = y
  df %>% mutate(across(starts_with(str_prefix), new_class))
}

# data load

base_emp_data <- read_dta('01_raw_data/cps_00007.dta')
base_closure_data <- read.csv('01_raw_data/state_lockdown_data.csv')
base_state_covid_history_data <- read.csv('01_raw_data/all-states-history.csv')
base_google_trends_data <- read.csv('01_raw_data/multiTimeline.csv')
```

## Reason for our analysis structure

In our analysis, we look at how COVID impacted the retail industry in terms of unemployment.
The objective for this analysis was to determine how many people were unemployed last year, if there was an obvious increase, and see if a correlation exists between COVID cases and unemployment. 
The first thing we did was plot a graph of the total reported unemployment per month. The unemployment data that we looked was collected from November of 2020 to January 2021. We also categorized the unemployment data into “Reason Why” as we wanted to specifically look at where the increase occurred in the following categories: "Laid Off", "Other" and "Temporary Job Ended". By looking at the unemployment data before the first cases were identified in the US, and several months after, we are able to see if total unemployment increased due to COVID.
We found that in April of 2020 data began to be reported if unemployment was due to COVID and so we also graphed the total amount of reported unemployment per month including that information. We decided to do this to get a visualization of how many of unemployment reports were attributed to COVID. Answering the question, how does COVID impact the retail industry in terms of unemployment.
Once we could see that 2020 had a large spike of unemployment which was attributed to COVID, we established a hypothesis that covid-19 measures imposed to reduce the spread of the disease was the reason for the impact in the retail industry. Specifically, we looked at stay-at-home orders (SAH). We ran an LSDV model of layoffs and when specific lockdowns happened per state. We did not see a positive relationship between SAH orders and unemployment in the retail industry, so decided to look for another factor that could have caused unemployment. We also found that control for between variations of the states did not impact the relationship.
 Then, we decided to look at unemployment and cases of COVID. We made a standardized graph showing the unemployment and COVID cases and similarly, found a negative trend where the more reported cases of COVID, the less unemployment reported.
Finally, since it appeared that COVID cases were not the true reason for unemployment, we looked at other variables that may have caused unemployment. One in particular, Google searches for the term “COVID”, seemed to have a strong positive correlation with unemployment. We ran a linear model of the effect of Google searches and total positive reported COVID cases with unemployment, which was our final model.

## How our analysis answers “How Did COVID Impact the Retail Industry in Terms of Unemployment?”

Our analysis answers this question by first looking at how unemployment changed from before the first cases were identified in the US to months after this date. We saw a sharp increase of unemployment in March, which is when the first case was identified. In addition, we were able to see via a graph that the majority of unemployment cases were due to layoffs and the primary reason being COVID.
We took this question a bit further in trying to assess why unemployment occurred. We assumed that stay at home orders (SAH) would have led to more unemployment in the retail industry but saw an opposite trend due to return to work shortly after SAH were implemented. We also assumed the number of COVID cases per day would be the primary influencer of unemployment but actually found a negative relationship between COVID cases and unemployment. We did identify a strong positive relationship between Google trends searches and unemployment. This leads us to suspect that unemployment was due to the fear and concern about the pandemic and less about the actual cases.
We demonstrate that there is an irregular increase in unemployment in 2020 in the retail industry due to COVID, as reported through unemployment reports. We also explore which factors about COVID led to this increase in unemployment.

## Data Set Used for Analysis

To see the unemployment amount in 2020, we collected data from the IPUMS Current Population Survey and specifically looked at work information like industry, employment status and reason why unemployed. We also gathered data from the COVID details that began to be collected in May, which was, “Unable to work due to COVID-19 pandemic”. We narrowed down the industry to be just retail and also only looked at the following reasons for unemployment: "Laid Off", "Other" and "Temporary Job Ended" as we were less interested in those who left their job by choice or if someone was a re-entrant or new entrant. 


##Glen, can you please complete this question? Not sure where your data came from.


## Interpretation of Regression Results and Presentation of Results


The following analysis attempts to identify how COVID-19 affected the health of the retail industry. This analysis uses retail unemployment as a measure of industry health. The assumption is that a healthy retail industry has a consistent flow of revenues enabling it to maintain a uniformed sized employee pool. An unhealthy industry would be characterized by high layoffs rates as retail revenues drop forcing retailers to minimize losses by reducing employee attributed operational costs.

```{r, echo=FALSE, message=FALSE, warning = FALSE}
# data wrangling ----

wip_emp_data <- base_emp_data %>% 
  filter(!(whyunemp == 0)) %>% 
  filter(occ2010 %in% c(4700:5790)) %>% 
  filter(whyunemp %in% c(1,2,3)) %>% 
  class_conversion(c('month', 'durunemp', 'statefip'), as.numeric) %>% 
  class_conversion(c('occ', 'covidunaw', 'whyunemp'), as.factor) %>% 
  select(-'serial')

exploration_base_employment_df <- wip_emp_data %>% 
  group_by(year, month, statefip) %>% 
  mutate(layoff = sum(whyunemp == 1), 
         other_type_loss = sum(whyunemp == 2), 
         temp_job_end = sum(whyunemp == 3), 
         covidunaw = sum(covidunaw == 2)) %>% 
  mutate(covid_impact_no = sum(covidunaw == 1), 
         covid_impact_yes = sum(covidunaw == 2)) %>% 
  select(-'whyunemp', -'covidunaw', -'occ2010', -'empstat') %>% 
  summarise(layoff = sum(layoff), 
            other_type_loss = sum(other_type_loss), 
            temp_job_end = sum(temp_job_end), 
            covid_impact_yes = sum(covid_impact_yes), 
            covid_impact_no = sum(covid_impact_no)) %>% 
  mutate(survey_dates = ymd(paste0(year, '-', month, '-01'))) %>% 
  left_join(base_closure_data, 'statefip') %>% 
  select(-'lck_dwn_st')

wip_state_closures <- base_closure_data %>% 
  mutate(lck_dwn_st = mdy(lck_dwn_st))

state_name_key <- read.csv('01_raw_data/state_names.csv')

state_name_key <- state_name_key %>% select(-'Abbrev') %>% 
  rename(state_code = Code)

exploration_base_state_covide_df <- base_state_covid_history_data %>% 
  filter(!(state %in% c('AS', 'GU', 'MP','PR'))) %>% 
  rename(state_code = state) %>% 
  mutate(date = mdy(date)) %>% 
  mutate(date = ymd(date)) %>% 
  left_join(state_name_key, 'state_code') %>% 
  rename(state = 'State')
  
  # google trends wrangling

wip_google_trends <- base_google_trends_data %>% 
  mutate(Week = mdy(Week)) %>% mutate(Week = ymd(Week)) %>% 
  rename(date = Week)

```

## How Did COVID Impact Unemployment?
This analysis used employment data collected by IPMUS, with sample dates ranging from January 2019 to January 2021. The variables used were:

| Variable   | Definition |  
|:------:    |:-------------------------------------------------     | 
| "whyunemp' | specifies why respondents were unemployed             |
| "occ2010"  | occupation coding based on the Census Bureau's scheme |
| "covidunaw"| unemployment attributed to COVID-19                   |
| "lck_w_st" | start of stay-at-home orders for states that had them |

Unemployment from the data was categorized into three "reason whys" specifically "Laid Off", "Other", and "Temporary Job Ended". INitial visualization of the data shows that there was an increase in unemployment around the time COVID-19 cases began accumulating in US (March - April 2020). Being laid off was identified as the primary reason unemployment during this same time frame. We also saw minimal change in monthly unemployment rates for temporary workers. For these reasons the analysis focuses on unemployment attributed to being laid off. The second plot shows a new variable that started being collected in April 2020, that identified those who could attribute their unemployment directly to COVID-19. Interestingly the slope of the decline in unemployment attributed to covid-19 mirrors the overall trend of unemployment decrease quickly following April.

```{r}

sum_by_why <- wip_emp_data %>%
  mutate(date = ymd(paste0(year, '-', month, '-01'))) %>% 
  count(date, whyunemp) %>%
  filter(date >= "2019-12-01")

plot_by_why <- sum_by_why %>%
  ggplot(aes(x = date, y = n, fill = factor(whyunemp)))+
  scale_fill_discrete(name = "Reason",
                      labels=c("Laid Off", "Other",
                               "Temporary Work Concluded")) +
  geom_bar(position = "dodge", stat = "identity") +
  theme(legend.position="bottom") + 
  xlab("Month") +
  ylab("Number of People")
plot_by_why

sum_unemp <- wip_emp_data %>%
  #na_if(99) %>%
  count(survey_dates, covidunaw) %>%
  filter(covidunaw %in% c(1, 2, NA)) %>%
  filter(survey_dates >= "2019-11-01")
sum_unemp[is.na(sum_unemp)] <- 0

plot_total <- ggplot(data = sum_unemp, aes(x = date, y = n, fill = factor(covidunaw))) +
  geom_bar(position = "stack", stat = "identity") +
  scale_fill_manual(name = "Covid Unemployment",
                      labels = c("Not Recorded", "Covid related", "Not Related"),
                      values = c('gray', "darkseagreen", "coral")) +
  theme(legend.position="bottom")
plot_total
```

The original hypothesis was that covid-19 measures imposed to reduce the spread of the disease was the reason for the impact in the retail industry. Specifically we looked at stay-at-home orders (SAH)

H~O~ = COVID-19 did not have an impact on the retail industry as measured by unemployment.

H~A~ = COVID-19, in the form of state stay at home orders (SAH), negatively impacted the retail industry's health as measured by unemployment. 
 The following model 

The following model assessed if there was a relationship between when SAH orders where implemented and unemployment.The original model included a LSDV factor for states to provide a fixed effect control; however, it was discovered that the between variation of states had no impact on the relationship.
```{r}
state_closure_layoff_df <- exploration_base_employment_df %>% 
  select('state', 'month', 'year', 'layoff') %>% 
  left_join(wip_state_closures, 'state')

lm_state_closure_layoff_df <- lm_robust(layoff ~ lck_dwn_st, 
                                        data = state_closure_layoff_df)  

export_summs(lm_state_closure_layoff_df, model.names = 'Relationship Between \nLayoffs and SAH')
```
The model actually shows that there is negative relationship between layoffs and SAH order start days. This is understandable as the following graph shows that retail industry's health was starting to improve - as indicated by a decrease in unemployment - following the first SAH. The following plots layoffs, growth in total covid cases, and the date of the first SAH. 

```{r, echo = FALSE, message = FALSE, warning = FALSE}
# visualizations: the following code does some specific data wrangling
# and produces some initial data visualizations. The wrangling includes 
# standardizing of all the variables then merged into a single dataframe. 

wip_emp_mod_1 <- exploration_base_employment_df %>% 
  rename(date = 'survey_dates') %>% 
  filter(date >= as.Date('2019-12-01')) %>% 
  select('date', 'layoff', 'year', 'month') %>% 
  group_by(date) %>% 
  summarise(monthly_av_layoff = mean(layoff)) %>% 
  mutate(yearly_av_layoff = mean(monthly_av_layoff),
         monthly_sd = sd(monthly_av_layoff),
         monthly_std_layoff = (monthly_av_layoff - yearly_av_layoff)/monthly_sd)

wip_state_covid_history_mod_1 <- exploration_base_state_covide_df %>% 
  filter(date >= as.Date('2019-12-01')) %>% 
  mutate(year = year(date), month = month(date)) %>% 
  group_by(year, month) %>% 
  mutate_all(funs(ifelse(is.na(.), 0, .))) %>% 
  summarise(national_monthly_positive = sum(positive)) %>% 
  mutate(mean_positive = mean(national_monthly_positive), 
         positive_sd = sd(national_monthly_positive), 
         std_monthly_positive = (national_monthly_positive - mean_positive)/positive_sd, 
         date = ymd(paste0(year, '-', month, '-01')))

base_layoff_covid_cases <- wip_emp_mod_1 %>% 
  left_join(wip_state_covid_history_mod_1, by = c('date'))

ggplot(base_layoff_covid_cases) + 
  geom_smooth( aes(x =date, y = monthly_std_layoff, colour = "Layoffs"), se = FALSE) + 
  geom_smooth(aes(x = date, y = std_monthly_positive, colour = 'Total COVID \nCases'), se = FALSE) +
  xlim(as.Date('2019-12-01'), as.Date('2021-01-01')) +
  geom_vline(xintercept = as.Date("2020-03-18"), color = 'black') +
  labs(colour = "Legend, \nStandardized Values") +
  ggtitle('Layoff Trends v. Total COVID Cases v. Start of SAH Orders') +
  xlab('Date') + 
  ylab('Standard Deviations \nLayoffs and Cases') +
  geom_text(aes(x = as.Date("2020-03-01"), label = "\n1st SAH Order", y=-2.0), colour="black", 
            angle=90, text=element_text(size=4))
```

Since the model showed that SAH did not have a positive relationship with the decline in the retail industry's health - indicated by increased layoffs - we conducted a review of previous research and found a study that assessed social media's affect on creating a "Pandemic Panic". We decided to follow the paper's hypothesis but assesses if Google Search trends for the term 'covid' had a relationship with layoffs. The following plot shows google searches for covid, layoffs, covid cases and major events such as the first SAH and vaccine emergency authorization. The plot does show that covid search trends did parallel the layoff rates. 

```{r, echo = FALSE}

wip_layoff_google_trends <- wip_google_trends %>% 
  filter(!(Covid...United.States.) == '<1') %>% 
  filter(date >= as.Date('2019-12-01')) %>% 
  mutate(year = year(date), month = month(date)) %>% 
  group_by(year, month) %>% 
  class_conversion('Covid...United.States.', as.numeric) %>% 
  summarise(monthly_trend_mean = mean(Covid...United.States.), 
            trend_sd = sd(Covid...United.States.)) %>% 
  mutate(yearly_mean = mean(monthly_trend_mean), 
         monthly_trend_sd = sd(monthly_trend_mean), 
         std_month_score = (monthly_trend_mean - yearly_mean)/monthly_trend_sd,
         date = ymd(paste0(year, '-', month, '-01')))

wip_layoff_covid_cases_google_trends_df <- wip_emp_mod_1 %>% 
  left_join(wip_state_covid_history_mod_1, 'date') %>% 
  left_join(wip_layoff_google_trends, 'date')

ggplot(wip_layoff_covid_cases_google_trends_df) + 
  geom_smooth( aes(x =date, y = monthly_std_layoff, colour = "Layoffs"), se = FALSE) + 
  geom_smooth(aes(x = date, y = std_month_score, colour = 'Google COVID \nSearch Trends'), se = FALSE) +
  geom_smooth(aes(x = date, y = std_monthly_positive, colour = 'Total COVID \nCases'), se = FALSE) +
  xlim(as.Date('2019-12-01'), as.Date('2021-01-01')) +
  geom_vline(xintercept = as.Date("2020-03-18"), color = 'black') +
  geom_vline(xintercept = as.Date("2020-12-18"), color = 'orange') +
  geom_vline(xintercept = as.Date("2020-12-11"), color = 'orange') + 
  labs(colour = "Legend, \nStandardized Values") +
  ggtitle('Google COVID Search Trends v. Retail Layoffs v. Total COVID Cases') +
  xlab('Date') + 
  ylab('Standard Deviations') +
  geom_text(aes(x=as.Date("2020-03-01"), label="\n1st SAH Order", y=-1.75), colour="black", 
            angle=90, text=element_text(size=4)) +
  geom_text(aes(x=as.Date("2020-12-01"), label="Vaccine Authorizations", y=-1.5), colour="orange", 
            angle=90, text=element_text(size=4))

```
With the plot showing a potential relationship between ggogle search trends and layoffs. The following model was ran.
```{r}
lm_gtrend_ccases_layoffs <-  lm_robust( monthly_std_layoff ~ std_month_score +
                             std_monthly_positive, data = wip_layoff_covid_cases_google_trends_df)

export_summs(lm_gtrend_ccases_layoffs, 
             model.names = 'Layoff v. Covid Search Trends v. Total Cases')
```
This model did show a positive statically signifcant relationship at the .05% confidence interval between increases in google searches for covid and the increase in layoff.  This indicates that covid did potentially impact the retail industry's health but not in the way expect, either through SAH or the growth in cases.  It appear that information about covid found through google searches may have changed the behavior of retail shoppers that lead to a decline in the health of the retail industry as indicated by layoffs.


## Assumption Acknowledgement

We are assuming when looking at the relationship of COVID cases and unemployment, that there is a minimal effect on unemployment effecting COVID cases and also Google searches. 
We also assume the the relationship remains linear.

May need to fill this in more!

## Final Results: “How Did COVID Impact the Retail Industry in Terms of Unemployment?”

Covid did impact the retail industry negatively as we saw a rise in unemployment in 2020.

We see that the retail industry had a large spike in unemployment right around the time that the first positive cases of COVID were being reported in the US. We also see that unemployment was on the rise, even before the stay at home orders were implemented. By the time the stay at home orders were implemented, unemployment had almost peaked and began trending downwards. We also see that unemployment peaked and returned to much lower levels before positive cases actually began to spike upward. Further analysis needs to be completed to control for other potential variables, but our current take away is that Google trends had a positive relationship that was statistically significant in relation to unemployment. Our conclusion is that fear of the pandemic may have been a major cause of unemployment, over the stay at home orders and actuall positive cases.

While the retail industry had high levels of unemployment throughout 2020, the majority of those unemployments were specific to COVID and we see a major decrease in unemployment which remains relatively consistant between October 2020 to January 2021. While unemployment rates in the retail industry have not returned to what it was pre-covid, it is in much better standing compared to the peak in April.


